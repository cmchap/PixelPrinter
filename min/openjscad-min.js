OpenJsCad=function(){},OpenJsCad.log=function(e){var t=Date.now(),n=OpenJsCad.log.prevLogTime;n||(n=t);var i=t-n;OpenJsCad.log.prevLogTime=t;var r=(.001*i).toFixed(3);if(e="["+r+"] "+e,"object"==typeof console&&"function"==typeof console.log)console.log(e);else{if("object"!=typeof self||"function"!=typeof self.postMessage)throw new Error("Cannot log");self.postMessage({cmd:"log",txt:e})}},OpenJsCad.Viewer=function(e,t){var n=GL.create();this.gl=n,this.angleX=-30,this.angleY=0,this.angleZ=180,this.viewpointX=-5,this.viewpointY=-10,this.viewpointZ=t,this.touch={lastX:0,lastY:0,scale:0,ctrl:0,shiftTimer:null,shiftControl:null,cur:null},this.drawAxes=!0,this.drawLines=!1,this.lineOverlay=!1,this.gl.canvas.width=$(e).width(),this.gl.canvas.height=$(e).height(),this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.matrixMode(this.gl.PROJECTION),this.gl.loadIdentity(),this.gl.perspective(45,this.gl.canvas.width/this.gl.canvas.height,.5,1e3),this.gl.matrixMode(this.gl.MODELVIEW),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.clearColor(.93,.93,.93,1),this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.CULL_FACE),this.gl.polygonOffset(1,1),this.blackShader=new GL.Shader("    void main() {      gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;    }","    void main() {      gl_FragColor = vec4(0.0, 0.0, 0.0, 0.1);    }"),this.lightingShader=new GL.Shader("      varying vec3 color;      varying float alpha;      varying vec3 normal;      varying vec3 light;      void main() {        const vec3 lightDir = vec3(1.0, 2.0, 3.0) / 3.741657386773941;        light = lightDir;        color = gl_Color.rgb;        alpha = gl_Color.a;        normal = gl_NormalMatrix * gl_Normal;        gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;      }","      varying vec3 color;      varying float alpha;      varying vec3 normal;      varying vec3 light;      void main() {        vec3 n = normalize(normal);        float diffuse = max(0.0, dot(light, n));        float specular = pow(max(0.0, -reflect(light, n).z), 10.0) * sqrt(diffuse)*0.1;        gl_FragColor = vec4(mix(color * (0.3 + 0.7 * diffuse), vec3(1.0), specular), alpha);      }");var i=this,r=$('<div class="shift-scene"><div class="arrow arrow-left" />    <div class="arrow arrow-right" />    <div class="arrow arrow-top" />    <div class="arrow arrow-bottom" /></div>');this.touch.shiftControl=r,$(e).append(this.gl.canvas).append(r).hammer({drag_lock_to_axis:!0}).on("transform",function(e){e.gesture.touches.length>=2&&(i.clearShift(),i.onTransform(e),e.preventDefault())}).on("touch",function(e){if("touch"!=e.gesture.pointerType)return void e.preventDefault();if(1==e.gesture.touches.length){var t=e.gesture.center;i.touch.shiftTimer=setTimeout(function(){r.addClass("active").css({left:t.pageX+"px",top:t.pageY+"px"}),i.touch.shiftTimer=null,i.touch.cur="shifting"},500)}else i.clearShift()}).on("drag",function(e){return"touch"!=e.gesture.pointerType?void e.preventDefault():void(i.touch.cur&&"dragging"!=i.touch.cur?"shifting"==i.touch.cur&&i.onShift(e):(i.clearShift(),i.onPanTilt(e)))}).on("touchend",function(e){i.clearShift(),i.touch.cur&&r.removeClass("active shift-horizontal shift-vertical")}).on("transformend dragstart dragend",function(e){("transformend"==e.type&&"transforming"==i.touch.cur||"dragend"==e.type&&"shifting"==i.touch.cur||"dragend"==e.type&&"dragging"==i.touch.cur)&&(i.touch.cur=null),i.touch.lastX=0,i.touch.lastY=0,i.touch.scale=0}),this.gl.onmousemove=function(e){i.onMouseMove(e)},this.gl.ondraw=function(){i.onDraw()},this.gl.resizeCanvas=function(){var e=i.gl.canvas.clientWidth,t=i.gl.canvas.clientHeight;(i.gl.canvas.width!=e||i.gl.canvas.height!=t)&&(i.gl.canvas.width=e,i.gl.canvas.height=t,i.gl.viewport(0,0,i.gl.canvas.width,i.gl.canvas.height),i.gl.matrixMode(i.gl.PROJECTION),i.gl.loadIdentity(),i.gl.perspective(45,i.gl.canvas.width/i.gl.canvas.height,.5,1e3),i.gl.matrixMode(i.gl.MODELVIEW),i.onDraw())},window.addEventListener("resize",this.gl.resizeCanvas),this.gl.onmousewheel=function(e){var t=0;if(e.wheelDelta?t=e.wheelDelta:e.detail&&(t=-40*e.detail),t){var n=Math.pow(1.003,-t),r=i.getZoom();r*=n,i.setZoom(r)}},this.clear()},OpenJsCad.Viewer.prototype={setCsg:function(e){if(0)for(var t=0;t<e.length;t++)this.meshes.concat(OpenJsCad.Viewer.csgToMeshes(e[t]));else this.meshes=OpenJsCad.Viewer.csgToMeshes(e);this.onDraw()},clear:function(){this.meshes=[],this.onDraw()},supported:function(){return!!this.gl},ZOOM_MAX:1e3,ZOOM_MIN:10,onZoomChanged:null,plate:!0,state:0,setZoom:function(e){e=Math.max(e,0),e=Math.min(e,1),this.viewpointZ=this.ZOOM_MIN+e*(this.ZOOM_MAX-this.ZOOM_MIN),this.onZoomChanged&&this.onZoomChanged(),this.onDraw()},getZoom:function(){var e=(this.viewpointZ-this.ZOOM_MIN)/(this.ZOOM_MAX-this.ZOOM_MIN);return e},onMouseMove:function(e){if(e.dragging){var t=e.button;if(e.which&&(t=e.which),e.preventDefault(),e.altKey||3==t)this.angleY+=e.deltaX,this.angleX+=e.deltaY;else if(e.shiftKey||2==t){var n=.005;this.viewpointX+=n*e.deltaX*this.viewpointZ,this.viewpointY-=n*e.deltaY*this.viewpointZ}else if(e.ctrlKey){var n=Math.pow(1.006,e.deltaX+e.deltaY),i=this.getZoom();i*=n,this.setZoom(i)}else this.angleZ+=e.deltaX,this.angleX+=e.deltaY;this.onDraw()}},clearShift:function(){return this.touch.shiftTimer&&(clearTimeout(this.touch.shiftTimer),this.touch.shiftTimer=null),this},onPanTilt:function(e){this.touch.cur="dragging";var t=0;!this.touch.lastY||"up"!=e.gesture.direction&&"down"!=e.gesture.direction?!this.touch.lastX||"left"!=e.gesture.direction&&"right"!=e.gesture.direction||(t=e.gesture.deltaX-this.touch.lastX,this.angleZ+=t):(t=e.gesture.deltaY-this.touch.lastY,this.angleX+=t),t&&this.onDraw(),this.touch.lastX=e.gesture.deltaX,this.touch.lastY=e.gesture.deltaY},onShift:function(e){this.touch.cur="shifting";var t=.005,n=0;!this.touch.lastY||"up"!=e.gesture.direction&&"down"!=e.gesture.direction||(this.touch.shiftControl.removeClass("shift-horizontal").addClass("shift-vertical").css("top",e.gesture.center.pageY+"px"),n=e.gesture.deltaY-this.touch.lastY,this.viewpointY-=t*n*this.viewpointZ,this.angleX+=n),!this.touch.lastX||"left"!=e.gesture.direction&&"right"!=e.gesture.direction||(this.touch.shiftControl.removeClass("shift-vertical").addClass("shift-horizontal").css("left",e.gesture.center.pageX+"px"),n=e.gesture.deltaX-this.touch.lastX,this.viewpointX+=t*n*this.viewpointZ,this.angleZ+=n),n&&this.onDraw(),this.touch.lastX=e.gesture.deltaX,this.touch.lastY=e.gesture.deltaY},onTransform:function(e){if(this.touch.cur="transforming",this.touch.scale){var t=1/(1+e.gesture.scale-this.touch.scale),n=this.getZoom();n*=t,this.setZoom(n)}return this.touch.scale=e.gesture.scale,this},onDraw:function(e){var t=this.gl;t.makeCurrent(),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.loadIdentity(),t.translate(this.viewpointX,this.viewpointY,-this.viewpointZ),t.rotate(this.angleX,1,0,0),t.rotate(this.angleY,0,1,0),t.rotate(this.angleZ,0,0,1),t.enable(t.BLEND),this.lineOverlay||t.enable(t.POLYGON_OFFSET_FILL);for(var n=0;n<this.meshes.length;n++){var i=this.meshes[n];this.lightingShader.draw(i,t.TRIANGLES)}if(this.lineOverlay||t.disable(t.POLYGON_OFFSET_FILL),t.disable(t.BLEND),this.drawLines){this.lineOverlay&&t.disable(t.DEPTH_TEST),t.enable(t.BLEND);for(var n=0;n<this.meshes.length;n++){var i=this.meshes[n];this.blackShader.draw(i,t.LINES)}t.disable(t.BLEND),this.lineOverlay&&t.enable(t.DEPTH_TEST)}if(this.drawAxes){t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.begin(t.LINES);var r=200;if(this.plate){t.color(.8,.8,.8,.5);for(var s=-r/2;r/2>=s;s++)s%10&&(t.vertex(-r/2,s,0),t.vertex(r/2,s,0),t.vertex(s,-r/2,0),t.vertex(s,r/2,0));t.color(.5,.5,.5,.5);for(var s=-r/2;r/2>=s;s+=10)t.vertex(-r/2,s,0),t.vertex(r/2,s,0),t.vertex(s,-r/2,0),t.vertex(s,r/2,0)}t.end(),t.disable(t.BLEND)}}},OpenJsCad.Viewer.csgToMeshes=function(e){for(var t=e.canonicalized(),n=new GL.Mesh({normals:!0,colors:!0}),i=[n],r={},s=[],o=[],a=[],l=!1,h=t.toPolygons(),c=h.length,u=0;c>u;u++){var d=h[u],p=[1,.4,1,1];d.shared&&d.shared.color&&(p=d.shared.color),d.color&&(p=d.color),p.length<4&&p.push(1);for(var f=(d.vertices.map(function(e){var t=e.getTag(),n;return l&&t in r?n=r[t]:(n=s.length,r[t]=n,s.push([e.pos.x,e.pos.y,e.pos.z]),o.push(p)),n})),g=2;g<f.length;g++)a.push([f[0],f[g-1],f[g]]);s.length>65e3&&(n.triangles=a,n.vertices=s,n.colors=o,n.computeWireframe(),n.computeNormals(),n.vertices.length&&i.push(n),n=new GL.Mesh({normals:!0,colors:!0}),a=[],o=[],s=[])}return n.triangles=a,n.vertices=s,n.colors=o,n.computeWireframe(),n.computeNormals(),n.vertices.length&&i.push(n),i},OpenJsCad.makeAbsoluteUrl=function(e,t){if(!e.match(/^[a-z]+\:/i)){var n=t.split("/");n.length>0&&n.splice(n.length-1,1);var i=e.split("/"),r=n.concat(i),s=[];r.map(function(e){".."==e?s.length>0&&s.splice(s.length-1,1):s.push(e)}),e="";for(var o=0;o<s.length;o++)o>0&&(e+="/"),e+=s[o]}return e},OpenJsCad.isChrome=function(){return navigator.userAgent.search("Chrome")>=0},OpenJsCad.runMainInWorker=function(e){try{if("function"!=typeof main)throw new Error("Your jscad file should contain a function main() which returns a CSG solid or a CAG area.");OpenJsCad.log.prevLogTime=Date.now();var t=main(e);if(!("object"==typeof t&&(t instanceof CSG||t instanceof CAG)),t.length){var n=t[0];n instanceof CAG&&(n=n.extrude({offset:[0,0,.1]}));for(var i=1;i<t.length;i++){var r=t[i];r instanceof CAG&&(r=r.extrude({offset:[0,0,.1]})),n=n.unionForNonIntersecting(r)}t=n}var s=t.toCompactBinary();t=null,self.postMessage({cmd:"rendered",result:s})}catch(o){var a=o.toString();o.stack&&(a+="\nStack trace:\n"+o.stack),self.postMessage({cmd:"error",err:a})}},OpenJsCad.parseJsCadScriptSync=function(script,mainParameters,debugging){var workerscript="//SYNC\n";if(workerscript+="_includePath = "+JSON.stringify(_includePath)+";\n",workerscript+=script,debugging&&(workerscript+="\n\n\n\n\n\n\n/* -------------------------------------------------------------------------\n",workerscript+="OpenJsCad debugging\n\nAssuming you are running Chrome:\nF10 steps over an instruction\nF11 steps into an instruction\n",workerscript+="F8  continues running\nPress the (||) button at the bottom to enable pausing whenever an error occurs\n",workerscript+="Click on a line number to set or clear a breakpoint\n",workerscript+="For more information see: http://code.google.com/chrome/devtools/docs/overview.html\n\n",workerscript+="------------------------------------------------------------------------- */\n",workerscript+="\n\n// Now press F11 twice to enter your main() function:\n\n",workerscript+="debugger;\n"),workerscript+="var me = "+JSON.stringify(me)+";\n",workerscript+="return main("+JSON.stringify(mainParameters)+");",workerscript+="function include(fn) {  if(0) {    _csg_libraries.push(fn);  } else if(0) {    var url = _includePath!=='undefined'?_includePath:'./';    var index = url.indexOf('index.html');    if(index!=-1) {       url = url.substring(0,index);    }  	 importScripts(url+fn);  } else {   console.log('SYNC checking gMemFs for '+fn);   if(gMemFs[fn]) {      console.log('found locally & eval:',gMemFs[fn].name);      eval(gMemFs[fn].source); return;   }   var xhr = new XMLHttpRequest();   xhr.open('GET',_includePath+fn,false);   console.log('include:'+_includePath+fn);   xhr.onload = function() {      var src = this.responseText;      eval(src);   };   xhr.onerror = function() {   };   xhr.send();  }}",0)return OpenJsCad.log.prevLogTime=Date.now(),eval(workerscript);var f=new Function(workerscript);return OpenJsCad.log.prevLogTime=Date.now(),f()},OpenJsCad.parseJsCadScriptASync=function(e,t,n,i){var r=["csg.js","openjscad.js","openscad.js"],s=document.location.href.replace(/\?.*$/,"");s=s.replace(/#.*$/,"");var o=s;null!=n.openJsCadPath&&(o=OpenJsCad.makeAbsoluteUrl(n.openJsCadPath,s));var a=[];null!=n.libraries&&(a=n.libraries);for(var l in gMemFs){var h=gMemFs[l].source+"\nfunction include() { }\n",c;try{c=new Function(h)}catch(u){this.setError(l+": "+u.message)}}var d="//ASYNC\n";d+="var me = "+JSON.stringify(me)+";\n",d+="var _csg_baseurl="+JSON.stringify(s)+";\n",d+="var _includePath="+JSON.stringify(_includePath)+";\n",d+="var gMemFs = [];\n";var p=!1,f;for(var g in gMemFs)d+="// "+gMemFs[g].name+":\n",f||(f=g),("main.jscad"==g||g.match(/\/main.jscad$/))&&(f=g),d+='gMemFs["'+gMemFs[g].name+'"] = '+JSON.stringify(gMemFs[g].source)+";\n",p=!0;d+=p?"eval(gMemFs['"+f+"']);\n":e,d+="\n\n\n\n//// The following code is added by OpenJsCad + OpenJSCAD.org:\n",d+="var _csg_baselibraries="+JSON.stringify(r)+";\n",d+="var _csg_libraries="+JSON.stringify(a)+";\n",d+="var _csg_openjscadurl="+JSON.stringify(o)+";\n",d+="var _csg_makeAbsoluteURL="+OpenJsCad.makeAbsoluteUrl.toString()+";\n",d+="_csg_baselibraries = _csg_baselibraries.map(function(l){return _csg_makeAbsoluteURL(l,_csg_openjscadurl);});\n",d+="_csg_libraries = _csg_libraries.map(function(l){return _csg_makeAbsoluteURL(l,_csg_baseurl);});\n",d+="_csg_baselibraries.map(function(l){importScripts(l)});\n",d+="_csg_libraries.map(function(l){importScripts(l)});\n",d+="self.addEventListener('message', function(e) {if(e.data && e.data.cmd == 'render'){",d+="  OpenJsCad.runMainInWorker("+JSON.stringify(t)+");",d+="}},false);\n",d+=p?"function include(fn) { eval(gMemFs[fn]); }\n":"function include(fn) {  if(0) {    _csg_libraries.push(fn);  } else if(1) {   if(gMemFs[fn]) {      eval(gMemFs[fn]); return;   }    var url = _csg_baseurl+_includePath;    var index = url.indexOf('index.html');    if(index!=-1) {       url = url.substring(0,index);    }  	 importScripts(url+fn);  } else {   var xhr = new XMLHttpRequest();   xhr.open('GET', _includePath+fn, true);   xhr.onload = function() {      return eval(this.responseText);   };   xhr.onerror = function() {   };   xhr.send();  }}";var m=OpenJsCad.textToBlobUrl(d);if(!window.Worker)throw new Error("Your browser doesn't support Web Workers. Please try the Chrome or Firefox browser instead.");var v=new Worker(m);return v.onmessage=function(e){if(e.data)if("rendered"==e.data.cmd){var t=e.data.result["class"],n;if("CSG"==t)n=CSG.fromCompactBinary(e.data.result);else{if("CAG"!=t)throw new Error("Cannot parse result");n=CAG.fromCompactBinary(e.data.result)}i(null,n)}else"error"==e.data.cmd?i(e.data.err,null):"log"==e.data.cmd&&console.log(e.data.txt)},v.onerror=function(e){var t="Error in line "+e.lineno+": "+e.message;i(t,null)},v.postMessage({cmd:"render"}),v},OpenJsCad.getWindowURL=function(){if(window.URL)return window.URL;if(window.webkitURL)return window.webkitURL;throw new Error("Your browser doesn't support window.URL")},OpenJsCad.textToBlobUrl=function(e){var t=OpenJsCad.getWindowURL(),n=new Blob([e],{type:"application/javascript"}),i=t.createObjectURL(n);if(!i)throw new Error("createObjectURL() failed");return i},OpenJsCad.revokeBlobUrl=function(e){if(window.URL)window.URL.revokeObjectURL(e);else{if(!window.webkitURL)throw new Error("Your browser doesn't support window.URL");window.webkitURL.revokeObjectURL(e)}},OpenJsCad.FileSystemApiErrorHandler=function(e,t){var n={1:"NOT_FOUND_ERR",2:"SECURITY_ERR",3:"ABORT_ERR",4:"NOT_READABLE_ERR",5:"ENCODING_ERR",6:"NO_MODIFICATION_ALLOWED_ERR",7:"INVALID_STATE_ERR",8:"SYNTAX_ERR",9:"INVALID_MODIFICATION_ERR",10:"QUOTA_EXCEEDED_ERR",11:"TYPE_MISMATCH_ERR",12:"PATH_EXISTS_ERR"},i;i=e.code in n?n[e.code]:"Error #"+e.code;var r="FileSystem API error: "+t+" returned error "+i;throw new Error(r)},OpenJsCad.AlertUserOfUncaughtExceptions=function(){window.onerror=function(e,t,n){e=e.replace(/^Uncaught /i,""),alert(e+"\n\n("+t+" line "+n+")")}},OpenJsCad.getParamDefinitions=function(e){var t=!0;e+="\nfunction include() {}";try{new Function(e)()}catch(n){t=!1}var i=[];if(t){var r="if(typeof(getParameterDefinitions) == 'function') {return getParameterDefinitions();} else {return [];} ";r+=e;var s=new Function(r);if(i=s(),"object"!=typeof i||"number"!=typeof i.length)throw new Error("The getParameterDefinitions() function should return an array with the parameter definitions")}return i},OpenJsCad.Processor=function(e,t){this.containerdiv=e,this.onchange=t,this.viewerdiv=null,this.viewer=null,this.zoomControl=null,this.initialViewerDistance=100,this.currentObject=null,this.hasOutputFile=!1,this.worker=null,this.paramDefinitions=[],this.paramControls=[],this.script=null,this.hasError=!1,this.debugging=!1,this.options={},this.createElements(),this.state=0},OpenJsCad.Processor.convertToSolid=function(e){if("object"==typeof e&&e instanceof CAG)e=e.extrude({offset:[0,0,.1]});else if("object"==typeof e&&e instanceof CSG);else{if(!e.length)throw new Error("Cannot convert to solid");for(var t=e[0],n=1;n<e.length;n++)t=t.unionForNonIntersecting(e[n]);e=t}return e},OpenJsCad.Processor.prototype={createElements:function(){for(var e=this;this.containerdiv.children.length>0;)this.containerdiv.removeChild(this.containerdiv.firstChild);var t=document.createElement("div");t.className="viewer",t.style.width="100%",t.style.height="100%",this.containerdiv.appendChild(t),this.viewerdiv=t;try{this.viewer=new OpenJsCad.Viewer(this.viewerdiv,this.initialViewerDistance)}catch(n){this.viewerdiv.innerHTML="<b><br><br>Error: "+n.toString()+"</b><br><br>OpenJsCad currently requires Google Chrome or Firefox with WebGL enabled"}if(0){var i=document.createElement("div");this.zoomControl=i.cloneNode(!1),this.zoomControl.style.width=this.viewerwidth+"px",this.zoomControl.style.height="20px",this.zoomControl.style.backgroundColor="transparent",this.zoomControl.style.overflowX="scroll",i.style.width=11*this.viewerwidth+"px",i.style.height="1px",this.zoomControl.appendChild(i),this.zoomChangedBySlider=!1,this.zoomControl.onscroll=function(t){var n=e.zoomControl,i=n.scrollLeft/(10*n.offsetWidth);e.zoomChangedBySlider=!0,e.viewer.setZoom(i),e.zoomChangedBySlider=!1},this.viewer.onZoomChanged=function(){if(!e.zoomChangedBySlider){var t=e.viewer.getZoom();e.zoomControl.scrollLeft=t*(10*e.zoomControl.offsetWidth)}},this.containerdiv.appendChild(this.zoomControl),this.zoomControl.scrollLeft=this.viewer.viewpointZ/this.viewer.ZOOM_MAX*(this.zoomControl.scrollWidth-this.zoomControl.offsetWidth)}this.errordiv=document.getElementById("errordiv"),this.errorpre=document.createElement("pre"),this.errordiv.appendChild(this.errorpre),this.statusdiv=document.getElementById("statusdiv"),this.statusdiv.className="statusdiv",this.statusspan=document.createElement("span"),this.statusspan.id="statusspan",this.statusspan.style.marginRight="2em",this.statusbuttons=document.createElement("span"),this.statusbuttons.style["float"]="right",this.statusdiv.appendChild(this.statusspan),this.statusdiv.appendChild(this.statusbuttons),this.abortbutton=document.createElement("button"),this.abortbutton.innerHTML="Abort",this.abortbutton.onclick=function(t){e.abort()},this.statusbuttons.appendChild(this.abortbutton),this.formatDropdown=document.createElement("select"),this.formatDropdown.onchange=function(t){e.currentFormat=e.formatDropdown.options[e.formatDropdown.selectedIndex].value,e.updateDownloadLink()},this.statusbuttons.appendChild(this.formatDropdown),this.generateOutputFileButton=document.createElement("button"),this.generateOutputFileButton.onclick=function(t){e.generateOutputFile()},this.statusbuttons.appendChild(this.generateOutputFileButton),this.downloadOutputFileLink=document.createElement("a"),this.downloadOutputFileLink.className="downloadOutputFileLink",this.statusbuttons.appendChild(this.downloadOutputFileLink),this.parametersdiv=document.getElementById("parametersdiv"),this.parametersdiv.id="parametersdiv";var r=document.createElement("div");r.innerHTML="Parameters:",r.className="parameterheader",this.parametersdiv.appendChild(r),this.parameterstable=document.createElement("table"),this.parameterstable.className="parameterstable",this.parametersdiv.appendChild(this.parameterstable);var s=document.createElement("button");s.innerHTML="Update",s.onclick=function(t){e.rebuildSolid()},this.parametersdiv.appendChild(s);var o=document.createElement("input");o.type="checkbox",o.id="instantUpdate",this.parametersdiv.appendChild(o);var a=document.createElement("span");a.innerHTML="Instant Update",a.id="instantUpdateLabel",this.parametersdiv.appendChild(a),this.enableItems(),this.clearViewer()},setCurrentObject:function(e){if(this.currentObject=e,this.viewer){var t=OpenJsCad.Processor.convertToSolid(e);this.viewer.setCsg(t),this.viewer.state=2,e.length&&(this.currentObject=t)}for(;this.formatDropdown.options.length>0;)this.formatDropdown.options.remove(0);var n=this;this.supportedFormatsForCurrentObject().forEach(function(e){var t=document.createElement("option");t.setAttribute("value",e),t.appendChild(document.createTextNode(n.formatInfo(e).displayName)),n.formatDropdown.options.add(t)}),this.updateDownloadLink()},selectedFormat:function(){return this.formatDropdown.options[this.formatDropdown.selectedIndex].value},selectedFormatInfo:function(){return this.formatInfo(this.selectedFormat())},updateDownloadLink:function(){var e=this.selectedFormatInfo().extension;this.generateOutputFileButton.innerHTML="Generate "+e.toUpperCase()},clearViewer:function(){this.clearOutputFile(),this.currentObject&&(this.setCurrentObject(new CSG),this.currentObject=null),this.viewer.state=1,this.enableItems()},abort:function(){1==this.state&&(this.statusspan.innerHTML="Aborted.",this.worker.terminate(),this.state=3,this.enableItems(),this.onchange&&this.onchange())},enableItems:function(){this.abortbutton.style.display=1==this.state?"inline":"none",this.formatDropdown.style.display=!this.hasOutputFile&&this.currentObject?"inline":"none",this.generateOutputFileButton.style.display=!this.hasOutputFile&&this.currentObject?"inline":"none",this.downloadOutputFileLink.style.display=this.hasOutputFile?"inline":"none",this.parametersdiv.style.display=this.paramControls.length>0?"inline-block":"none",this.errordiv.style.display=this.hasError?"block":"none",this.statusdiv.style.display=this.hasError?"none":"block"},setOpenJsCadPath:function(e){this.options.openJsCadPath=e},addLibrary:function(e){null==this.options.libraries&&(this.options.libraries=[]),this.options.libraries.push(e)},setError:function(e){this.hasError=""!=e,this.errorpre.textContent=e,this.enableItems()},setDebugging:function(e){this.debugging=e},setJsCad:function(e,t){t||(t="openjscad.jscad"),t=t.replace(/\.jscad$/i,""),this.abort(),this.paramDefinitions=[],this.paramControls=[],this.script=null,this.setError("");var n=!1;try{this.paramDefinitions=OpenJsCad.getParamDefinitions(e),this.createParamControls()}catch(i){this.setError(i.toString()),this.statusspan.innerHTML="Error.",n=!0}n?(this.enableItems(),this.onchange&&this.onchange()):(this.script=e,this.filename=t,this.rebuildSolid())},getParamValues:function(){for(var e={},t=0;t<this.paramDefinitions.length;t++){var n=this.paramDefinitions[t],i="text";"type"in n&&(i=n.type);var r=this.paramControls[t],s=null;if("text"==i||"float"==i||"int"==i||"number"==i){if(s=r.value,"float"==i||"int"==i||"number"==i){var o=!isNaN(parseFloat(s))&&isFinite(s);if(!o)throw new Error("Not a number: "+s);s="int"==i?parseInt(s):parseFloat(s)}}else"choice"==i&&(s=r.options[r.selectedIndex].value);e[n.name]=s}return e},rebuildSolid:function(){this.abort(),this.setError(""),this.clearViewer(),this.statusspan.innerHTML="Rendering code, please wait <img id=busy src='imgs/busy.gif'>",this.enableItems();var e=this,t=this.getParamValues(),n=this.debugging;if(!n)try{console.log("trying async compute"),e.state=1,this.worker=OpenJsCad.parseJsCadScriptASync(this.script,t,this.options,function(t,n){e.worker=null,t?(e.setError(t),e.statusspan.innerHTML="Error.",e.state=3):(e.setCurrentObject(n),e.statusspan.innerHTML="Ready.",e.state=2),e.enableItems(),e.onchange&&e.onchange()})}catch(i){console.log("async failed, try sync compute, error: "+i.message),n=!0}if(n){try{e.state=1,this.statusspan.innerHTML="Rendering code, please wait <img id=busy src='imgs/busy.gif'>";var r=OpenJsCad.parseJsCadScriptSync(this.script,t,this.debugging);e.setCurrentObject(r),e.statusspan.innerHTML="Ready.",e.state=2}catch(i){var s=i.toString();i.stack&&(s+="\nStack trace:\n"+i.stack),e.statusspan.innerHTML="Error.",e.state=3}e.enableItems(),e.onchange&&e.onchange()}},getState:function(){return this.state},clearOutputFile:function(){this.hasOutputFile&&(this.hasOutputFile=!1,this.outputFileDirEntry&&(this.outputFileDirEntry.removeRecursively(function(){}),this.outputFileDirEntry=null),this.outputFileBlobUrl&&(OpenJsCad.revokeBlobUrl(this.outputFileBlobUrl),this.outputFileBlobUrl=null),this.enableItems(),this.onchange&&this.onchange())},generateOutputFile:function(){if(this.clearOutputFile(),this.currentObject)try{this.generateOutputFileFileSystem()}catch(e){this.generateOutputFileBlobUrl()}},currentObjectToBlob:function(){var e=this.selectedFormat(),t;if("stla"==e)t=this.currentObject.toStlString(),t=new Blob([t],{type:this.formatInfo(e).mimetype});else if("stlb"==e)t=this.currentObject.toStlBinary({webBlob:!0});else if("amf"==e)t=this.currentObject.toAMFString({producer:"OpenJSCAD.org "+version,date:new Date}),t=new Blob([t],{type:this.formatInfo(e).mimetype});else if("x3d"==e)t=this.currentObject.fixTJunctions().toX3D();else{if("dxf"!=e)throw new Error("Not supported");t=this.currentObject.toDxf()}return t},supportedFormatsForCurrentObject:function(){if(this.currentObject instanceof CSG)return["stlb","stla","amf","x3d"];if(this.currentObject instanceof CAG)return["dxf"];throw new Error("Not supported")},formatInfo:function(e){return{stla:{displayName:"STL (ASCII)",extension:"stl",mimetype:"application/sla"},stlb:{displayName:"STL (Binary)",extension:"stl",mimetype:"application/sla"},amf:{displayName:"AMF (experimental)",extension:"amf",mimetype:"application/amf+xml"},x3d:{displayName:"X3D",extension:"x3d",mimetype:"model/x3d+xml"},dxf:{displayName:"DXF",extension:"dxf",mimetype:"application/dxf"}}[e]},downloadLinkTextForCurrentObject:function(){var e=this.selectedFormatInfo().extension;return"Download "+e.toUpperCase()},generateOutputFileBlobUrl:function(){var e=this.currentObjectToBlob(),t=OpenJsCad.getWindowURL();if(this.outputFileBlobUrl=t.createObjectURL(e),!this.outputFileBlobUrl)throw new Error("createObjectURL() failed");this.hasOutputFile=!0,this.downloadOutputFileLink.href=this.outputFileBlobUrl,this.downloadOutputFileLink.innerHTML=this.downloadLinkTextForCurrentObject();var n=this.selectedFormatInfo().extension;this.downloadOutputFileLink.setAttribute("download","openjscad."+n),this.enableItems(),this.onchange&&this.onchange()},generateOutputFileFileSystem:function(){if(window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,!window.requestFileSystem)throw new Error("Your browser does not support the HTML5 FileSystem API. Please try the Chrome browser instead.");var e="OpenJsCadOutput1_"+parseInt(1e9*Math.random(),10)+"."+t,t=this.selectedFormatInfo().extension,n="output."+t,i=this;window.requestFileSystem(TEMPORARY,20971520,function(t){t.root.getDirectory(e,{create:!0,exclusive:!0},function(e){i.outputFileDirEntry=e,e.getFile(n,{create:!0,exclusive:!0},function(e){e.createWriter(function(t){t.onwriteend=function(t){i.hasOutputFile=!0,i.downloadOutputFileLink.href=e.toURL(),i.downloadOutputFileLink.type=i.selectedFormatInfo().mimetype,i.downloadOutputFileLink.innerHTML=i.downloadLinkTextForCurrentObject(),i.downloadOutputFileLink.setAttribute("download",e.name),i.enableItems(),i.onchange&&i.onchange()},t.onerror=function(e){throw new Error("Write failed: "+e.toString())};var n=i.currentObjectToBlob();console.log(n,n.length),t.write(n)},function(e){OpenJsCad.FileSystemApiErrorHandler(e,"createWriter")})},function(e){OpenJsCad.FileSystemApiErrorHandler(e,"getFile('"+n+"')")})},function(t){OpenJsCad.FileSystemApiErrorHandler(t,"getDirectory('"+e+"')")})},function(e){OpenJsCad.FileSystemApiErrorHandler(e,"requestFileSystem")})},createParamControls:function(){this.parameterstable.innerHTML="",this.paramControls=[];for(var e=[],t=[],n=0;n<this.paramDefinitions.length;n++){var i="Error in parameter definition #"+(n+1)+": ",r=this.paramDefinitions[n];if(!("name"in r))throw new Error(i+"Should include a 'name' parameter");var s="text";if("type"in r&&(s=r.type),"text"!==s&&"int"!==s&&"float"!==s&&"choice"!==s&&"number"!==s)throw new Error(i+"Unknown parameter type '"+s+"'");var o;if("text"==s||"int"==s||"float"==s||"number"==s){o=document.createElement("input"),"number"==s?o.type="number":o.type="text","default"in r?o.value=r["default"]:"initial"in r?o.value=r.initial:"int"==s||"float"==s||"number"==s?o.value="0":o.value="",void 0!==r.size&&(o.size=r.size);for(var a in r)r.hasOwnProperty(a)&&"name"!=a&&"type"!=a&&"default"!=a&&"initial"!=a&&"caption"!=a&&o.setAttribute(a,r[a])}else if("choice"==s){if(!("values"in r))throw new Error(i+"Should include a 'values' parameter");o=document.createElement("select");var l=r.values,h;if("captions"in r){if(h=r.captions,h.length!=l.length)throw new Error(i+"'captions' and 'values' should have the same number of items")}else h=l;for(var c=0,u=0;u<l.length;u++){var d=document.createElement("option");d.value=l[u],d.text=h[u],o.add(d),"default"in r?r["default"]==l[u]&&(c=u):"initial"in r&&r.initial==l[u]&&(c=u)}l.length>0&&(o.selectedIndex=c)}o.onchange=function(){1==document.getElementById("instantUpdate").checked&&m.rebuildSolid()},e.push(o);var p=document.createElement("tr"),f=document.createElement("td"),g=r.name+":";"caption"in r&&(g=r.caption,f.className="caption"),f.innerHTML=g,p.appendChild(f),f=document.createElement("td"),f.appendChild(o),p.appendChild(f),t.push(p)}var m=this;t.map(function(e){m.parameterstable.appendChild(e)}),this.paramControls=e}};